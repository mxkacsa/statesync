{
  "version": "1.0",
  "package": "chase",
  "handlers": [
    {
      "name": "OnGameTick",
      "event": "GameTick",
      "parameters": [],
      "nodes": [
        {
          "id": "getCurrentTime",
          "type": "GetCurrentTime",
          "inputs": {}
        },
        {
          "id": "getGameStart",
          "type": "GetField",
          "inputs": { "path": {"constant": "GameStartTime"} }
        },
        {
          "id": "getGameDuration",
          "type": "GetField",
          "inputs": { "path": {"constant": "GameDurationHours"} }
        },
        {
          "id": "calcDurationSec",
          "type": "Multiply",
          "inputs": {
            "a": "node:getGameDuration:value",
            "b": {"constant": 3600}
          }
        },
        {
          "id": "calcEndTime",
          "type": "Add",
          "inputs": {
            "a": "node:getGameStart:value",
            "b": "node:calcDurationSec:result"
          }
        },
        {
          "id": "checkTimeUp",
          "type": "Compare",
          "inputs": {
            "left": "node:getCurrentTime:timestamp",
            "op": {"constant": ">="},
            "right": "node:calcEndTime:result"
          }
        },
        {
          "id": "ifTimeUp",
          "type": "If",
          "inputs": { "condition": "node:checkTimeUp:result" }
        },
        {
          "id": "setGameOver",
          "type": "SetField",
          "inputs": {
            "path": {"constant": "IsGameOver"},
            "value": {"constant": true}
          }
        },
        {
          "id": "setWinner",
          "type": "SetField",
          "inputs": {
            "path": {"constant": "WinningTeam"},
            "value": {"constant": "runner"}
          }
        },
        {
          "id": "emitGameOver",
          "type": "EmitToAll",
          "inputs": { "eventType": {"constant": "GameOver"} }
        }
      ],
      "flow": [
        { "from": "start", "to": "getCurrentTime" },
        { "from": "getCurrentTime", "to": "getGameStart" },
        { "from": "getGameStart", "to": "getGameDuration" },
        { "from": "getGameDuration", "to": "calcDurationSec" },
        { "from": "calcDurationSec", "to": "calcEndTime" },
        { "from": "calcEndTime", "to": "checkTimeUp" },
        { "from": "checkTimeUp", "to": "ifTimeUp" },
        { "from": "ifTimeUp", "to": "setGameOver", "label": "true" },
        { "from": "setGameOver", "to": "setWinner" },
        { "from": "setWinner", "to": "emitGameOver" },
        { "from": "emitGameOver", "to": "end" },
        { "from": "ifTimeUp", "to": "end", "label": "false" }
      ]
    },
    {
      "name": "OnTrySpawnBox",
      "event": "TrySpawnBox",
      "parameters": [],
      "nodes": [
        {
          "id": "getCurrentTime",
          "type": "GetCurrentTime",
          "inputs": {}
        },
        {
          "id": "getNextSpawnTime",
          "type": "GetField",
          "inputs": { "path": {"constant": "NextBoxSpawnTime"} }
        },
        {
          "id": "getBoxesSpawned",
          "type": "GetField",
          "inputs": { "path": {"constant": "BoxesSpawned"} }
        },
        {
          "id": "getMaxBoxes",
          "type": "GetField",
          "inputs": { "path": {"constant": "MaxSurpriseBoxes"} }
        },
        {
          "id": "checkTimeToSpawn",
          "type": "Compare",
          "inputs": {
            "left": "node:getCurrentTime:timestamp",
            "op": {"constant": ">="},
            "right": "node:getNextSpawnTime:value"
          }
        },
        {
          "id": "checkCanSpawnMore",
          "type": "Compare",
          "inputs": {
            "left": "node:getBoxesSpawned:value",
            "op": {"constant": "<"},
            "right": "node:getMaxBoxes:value"
          }
        },
        {
          "id": "canSpawn",
          "type": "And",
          "inputs": {
            "a": "node:checkTimeToSpawn:result",
            "b": "node:checkCanSpawnMore:result"
          }
        },
        {
          "id": "ifCanSpawn",
          "type": "If",
          "inputs": { "condition": "node:canSpawn:result" }
        },
        {
          "id": "randomLat",
          "type": "RandomFloat",
          "inputs": {
            "min": {"constant": 47.45},
            "max": {"constant": 47.55}
          }
        },
        {
          "id": "randomLng",
          "type": "RandomFloat",
          "inputs": {
            "min": {"constant": 19.0},
            "max": {"constant": 19.1}
          }
        },
        {
          "id": "randomPoints",
          "type": "RandomInt",
          "inputs": {
            "min": {"constant": 10},
            "max": {"constant": 100}
          }
        },
        {
          "id": "randomDelay",
          "type": "RandomInt",
          "inputs": {
            "min": {"constant": 60},
            "max": {"constant": 300}
          }
        },
        {
          "id": "incrementBoxCount",
          "type": "Add",
          "inputs": {
            "a": "node:getBoxesSpawned:value",
            "b": {"constant": 1}
          }
        },
        {
          "id": "createBox",
          "type": "CreateStruct",
          "inputs": {
            "type": {"constant": "SurpriseBox"},
            "fields": {
              "ID": "node:incrementBoxCount:result",
              "Lat": "node:randomLat:result",
              "Lng": "node:randomLng:result",
              "SpawnTime": "node:getCurrentTime:timestamp",
              "IsCollected": {"constant": false},
              "CollectedBy": {"constant": ""},
              "PointValue": "node:randomPoints:result"
            }
          }
        },
        {
          "id": "appendBox",
          "type": "ArrayAppend",
          "inputs": {
            "path": {"constant": "SurpriseBoxes"},
            "item": "node:createBox:result"
          }
        },
        {
          "id": "setBoxesSpawned",
          "type": "SetField",
          "inputs": {
            "path": {"constant": "BoxesSpawned"},
            "value": "node:incrementBoxCount:result"
          }
        },
        {
          "id": "calcNextSpawn",
          "type": "Add",
          "inputs": {
            "a": "node:getCurrentTime:timestamp",
            "b": "node:randomDelay:result"
          }
        },
        {
          "id": "setNextSpawn",
          "type": "SetField",
          "inputs": {
            "path": {"constant": "NextBoxSpawnTime"},
            "value": "node:calcNextSpawn:result"
          }
        },
        {
          "id": "emitBoxSpawned",
          "type": "EmitToAll",
          "inputs": { "eventType": {"constant": "SurpriseBoxSpawned"} }
        }
      ],
      "flow": [
        { "from": "start", "to": "getCurrentTime" },
        { "from": "getCurrentTime", "to": "getNextSpawnTime" },
        { "from": "getNextSpawnTime", "to": "getBoxesSpawned" },
        { "from": "getBoxesSpawned", "to": "getMaxBoxes" },
        { "from": "getMaxBoxes", "to": "checkTimeToSpawn" },
        { "from": "checkTimeToSpawn", "to": "checkCanSpawnMore" },
        { "from": "checkCanSpawnMore", "to": "canSpawn" },
        { "from": "canSpawn", "to": "ifCanSpawn" },
        { "from": "ifCanSpawn", "to": "randomLat", "label": "true" },
        { "from": "randomLat", "to": "randomLng" },
        { "from": "randomLng", "to": "randomPoints" },
        { "from": "randomPoints", "to": "randomDelay" },
        { "from": "randomDelay", "to": "incrementBoxCount" },
        { "from": "incrementBoxCount", "to": "createBox" },
        { "from": "createBox", "to": "appendBox" },
        { "from": "appendBox", "to": "setBoxesSpawned" },
        { "from": "setBoxesSpawned", "to": "calcNextSpawn" },
        { "from": "calcNextSpawn", "to": "setNextSpawn" },
        { "from": "setNextSpawn", "to": "emitBoxSpawned" },
        { "from": "emitBoxSpawned", "to": "end" },
        { "from": "ifCanSpawn", "to": "end", "label": "false" }
      ]
    },
    {
      "name": "OnPlayerUpdatePosition",
      "event": "PlayerUpdatePosition",
      "parameters": [
        { "name": "playerID", "type": "string" },
        { "name": "lat", "type": "float64" },
        { "name": "lng", "type": "float64" }
      ],
      "nodes": [
        {
          "id": "getGameZone",
          "type": "GetField",
          "inputs": { "path": {"constant": "GameZone"} }
        },
        {
          "id": "checkInZone",
          "type": "PointInPolygon",
          "inputs": {
            "pointLat": "param:lat",
            "pointLng": "param:lng",
            "polygon": "node:getGameZone:value"
          }
        },
        {
          "id": "ifInZone",
          "type": "If",
          "inputs": { "condition": "node:checkInZone:isInside" }
        },
        {
          "id": "updatePlayerPos",
          "type": "UpdateWhere",
          "inputs": {
            "path": {"constant": "Players"},
            "whereField": {"constant": "ID"},
            "whereOp": {"constant": "=="},
            "whereValue": "param:playerID",
            "updates": {
              "Lat": "param:lat",
              "Lng": "param:lng"
            }
          }
        },
        {
          "id": "emitPosUpdated",
          "type": "EmitToPlayer",
          "inputs": {
            "playerID": "param:playerID",
            "eventType": {"constant": "PositionAccepted"}
          }
        },
        {
          "id": "emitOutOfZone",
          "type": "EmitToPlayer",
          "inputs": {
            "playerID": "param:playerID",
            "eventType": {"constant": "OutOfGameZone"}
          }
        }
      ],
      "flow": [
        { "from": "start", "to": "getGameZone" },
        { "from": "getGameZone", "to": "checkInZone" },
        { "from": "checkInZone", "to": "ifInZone" },
        { "from": "ifInZone", "to": "updatePlayerPos", "label": "true" },
        { "from": "updatePlayerPos", "to": "emitPosUpdated" },
        { "from": "emitPosUpdated", "to": "end" },
        { "from": "ifInZone", "to": "emitOutOfZone", "label": "false" },
        { "from": "emitOutOfZone", "to": "end" }
      ]
    },
    {
      "name": "OnTryCollectBox",
      "event": "TryCollectBox",
      "parameters": [
        { "name": "playerID", "type": "string" },
        { "name": "boxID", "type": "string" }
      ],
      "nodes": [
        {
          "id": "getPlayer",
          "type": "GetPlayer",
          "inputs": { "playerID": "param:playerID" }
        },
        {
          "id": "getPlayerLat",
          "type": "GetStructField",
          "inputs": {
            "object": "node:getPlayer:player",
            "field": {"constant": "Lat"}
          }
        },
        {
          "id": "getPlayerLng",
          "type": "GetStructField",
          "inputs": {
            "object": "node:getPlayer:player",
            "field": {"constant": "Lng"}
          }
        },
        {
          "id": "iterateBoxes",
          "type": "ForEachWhere",
          "inputs": {
            "array": "state:SurpriseBoxes",
            "field": {"constant": "ID"},
            "op": {"constant": "=="},
            "value": "param:boxID"
          }
        },
        {
          "id": "getBoxLat",
          "type": "GetStructField",
          "inputs": {
            "object": "loop:item",
            "field": {"constant": "Lat"}
          }
        },
        {
          "id": "getBoxLng",
          "type": "GetStructField",
          "inputs": {
            "object": "loop:item",
            "field": {"constant": "Lng"}
          }
        },
        {
          "id": "checkNotCollected",
          "type": "GetStructField",
          "inputs": {
            "object": "loop:item",
            "field": {"constant": "IsCollected"}
          }
        },
        {
          "id": "isNotCollected",
          "type": "Not",
          "inputs": { "value": "node:checkNotCollected:value" }
        },
        {
          "id": "checkInRange",
          "type": "PointInCircle",
          "inputs": {
            "pointLat": "node:getPlayerLat:value",
            "pointLng": "node:getPlayerLng:value",
            "centerLat": "node:getBoxLat:value",
            "centerLng": "node:getBoxLng:value",
            "radiusMeters": {"constant": 10.0}
          }
        },
        {
          "id": "canCollect",
          "type": "And",
          "inputs": {
            "a": "node:isNotCollected:result",
            "b": "node:checkInRange:isInside"
          }
        },
        {
          "id": "ifCanCollect",
          "type": "If",
          "inputs": { "condition": "node:canCollect:result" }
        },
        {
          "id": "collectBox",
          "type": "UpdateStruct",
          "inputs": {
            "object": "loop:item",
            "fields": {
              "IsCollected": {"constant": true},
              "CollectedBy": "param:playerID"
            }
          }
        },
        {
          "id": "emitCollected",
          "type": "EmitToPlayer",
          "inputs": {
            "playerID": "param:playerID",
            "eventType": {"constant": "BoxCollected"}
          }
        }
      ],
      "flow": [
        { "from": "start", "to": "getPlayer" },
        { "from": "getPlayer", "to": "getPlayerLat" },
        { "from": "getPlayerLat", "to": "getPlayerLng" },
        { "from": "getPlayerLng", "to": "iterateBoxes" },
        { "from": "iterateBoxes", "to": "getBoxLat", "label": "body" },
        { "from": "getBoxLat", "to": "getBoxLng" },
        { "from": "getBoxLng", "to": "checkNotCollected" },
        { "from": "checkNotCollected", "to": "isNotCollected" },
        { "from": "isNotCollected", "to": "checkInRange" },
        { "from": "checkInRange", "to": "canCollect" },
        { "from": "canCollect", "to": "ifCanCollect" },
        { "from": "ifCanCollect", "to": "collectBox", "label": "true" },
        { "from": "collectBox", "to": "emitCollected" },
        { "from": "iterateBoxes", "to": "end", "label": "done" }
      ]
    },
    {
      "name": "OnCheckCapture",
      "event": "CheckCapture",
      "parameters": [
        { "name": "chaserID", "type": "string" }
      ],
      "nodes": [
        {
          "id": "getChaser",
          "type": "GetPlayer",
          "inputs": { "playerID": "param:chaserID" }
        },
        {
          "id": "getChaserLat",
          "type": "GetStructField",
          "inputs": {
            "object": "node:getChaser:player",
            "field": {"constant": "Lat"}
          }
        },
        {
          "id": "getChaserLng",
          "type": "GetStructField",
          "inputs": {
            "object": "node:getChaser:player",
            "field": {"constant": "Lng"}
          }
        },
        {
          "id": "getCaptureRadius",
          "type": "GetField",
          "inputs": { "path": {"constant": "CaptureRadius"} }
        },
        {
          "id": "iterateRunners",
          "type": "ForEachWhere",
          "inputs": {
            "array": "state:Players",
            "field": {"constant": "Team"},
            "op": {"constant": "=="},
            "value": {"constant": "runner"}
          }
        },
        {
          "id": "getRunnerCaptured",
          "type": "GetStructField",
          "inputs": {
            "object": "loop:item",
            "field": {"constant": "IsCaptured"}
          }
        },
        {
          "id": "isNotCaptured",
          "type": "Not",
          "inputs": { "value": "node:getRunnerCaptured:value" }
        },
        {
          "id": "ifNotCaptured",
          "type": "If",
          "inputs": { "condition": "node:isNotCaptured:result" }
        },
        {
          "id": "getRunnerLat",
          "type": "GetStructField",
          "inputs": {
            "object": "loop:item",
            "field": {"constant": "Lat"}
          }
        },
        {
          "id": "getRunnerLng",
          "type": "GetStructField",
          "inputs": {
            "object": "loop:item",
            "field": {"constant": "Lng"}
          }
        },
        {
          "id": "checkInCaptureRange",
          "type": "PointInCircle",
          "inputs": {
            "pointLat": "node:getRunnerLat:value",
            "pointLng": "node:getRunnerLng:value",
            "centerLat": "node:getChaserLat:value",
            "centerLng": "node:getChaserLng:value",
            "radiusMeters": "node:getCaptureRadius:value"
          }
        },
        {
          "id": "ifInRange",
          "type": "If",
          "inputs": { "condition": "node:checkInCaptureRange:isInside" }
        },
        {
          "id": "captureRunner",
          "type": "UpdateStruct",
          "inputs": {
            "object": "loop:item",
            "fields": {
              "IsCaptured": {"constant": true}
            }
          }
        },
        {
          "id": "emitCaptured",
          "type": "EmitToAll",
          "inputs": { "eventType": {"constant": "RunnerCaptured"} }
        }
      ],
      "flow": [
        { "from": "start", "to": "getChaser" },
        { "from": "getChaser", "to": "getChaserLat" },
        { "from": "getChaserLat", "to": "getChaserLng" },
        { "from": "getChaserLng", "to": "getCaptureRadius" },
        { "from": "getCaptureRadius", "to": "iterateRunners" },
        { "from": "iterateRunners", "to": "getRunnerCaptured", "label": "body" },
        { "from": "getRunnerCaptured", "to": "isNotCaptured" },
        { "from": "isNotCaptured", "to": "ifNotCaptured" },
        { "from": "ifNotCaptured", "to": "getRunnerLat", "label": "true" },
        { "from": "getRunnerLat", "to": "getRunnerLng" },
        { "from": "getRunnerLng", "to": "checkInCaptureRange" },
        { "from": "checkInCaptureRange", "to": "ifInRange" },
        { "from": "ifInRange", "to": "captureRunner", "label": "true" },
        { "from": "captureRunner", "to": "emitCaptured" },
        { "from": "iterateRunners", "to": "end", "label": "done" }
      ]
    },
    {
      "name": "OnUpdatePublicPositions",
      "event": "UpdatePublicPositions",
      "parameters": [],
      "nodes": [
        {
          "id": "getCurrentTime",
          "type": "GetCurrentTime",
          "inputs": {}
        },
        {
          "id": "iteratePlayers",
          "type": "ForEachWhere",
          "inputs": {
            "array": "state:Players",
            "field": {"constant": "ID"},
            "op": {"constant": "!="},
            "value": {"constant": ""}
          }
        },
        {
          "id": "getLastUpdate",
          "type": "GetStructField",
          "inputs": {
            "object": "loop:item",
            "field": {"constant": "LastPublicUpdate"}
          }
        },
        {
          "id": "calcTimeSince",
          "type": "Subtract",
          "inputs": {
            "a": "node:getCurrentTime:timestamp",
            "b": "node:getLastUpdate:value"
          }
        },
        {
          "id": "checkNeedsUpdate",
          "type": "Compare",
          "inputs": {
            "left": "node:calcTimeSince:result",
            "op": {"constant": ">="},
            "right": {"constant": 60}
          }
        },
        {
          "id": "ifNeedsUpdate",
          "type": "If",
          "inputs": { "condition": "node:checkNeedsUpdate:result" }
        },
        {
          "id": "getPrivateLat",
          "type": "GetStructField",
          "inputs": {
            "object": "loop:item",
            "field": {"constant": "Lat"}
          }
        },
        {
          "id": "getPrivateLng",
          "type": "GetStructField",
          "inputs": {
            "object": "loop:item",
            "field": {"constant": "Lng"}
          }
        },
        {
          "id": "updatePublicPos",
          "type": "UpdateStruct",
          "inputs": {
            "object": "loop:item",
            "fields": {
              "PublicLat": "node:getPrivateLat:value",
              "PublicLng": "node:getPrivateLng:value",
              "LastPublicUpdate": "node:getCurrentTime:timestamp"
            }
          }
        }
      ],
      "flow": [
        { "from": "start", "to": "getCurrentTime" },
        { "from": "getCurrentTime", "to": "iteratePlayers" },
        { "from": "iteratePlayers", "to": "getLastUpdate", "label": "body" },
        { "from": "getLastUpdate", "to": "calcTimeSince" },
        { "from": "calcTimeSince", "to": "checkNeedsUpdate" },
        { "from": "checkNeedsUpdate", "to": "ifNeedsUpdate" },
        { "from": "ifNeedsUpdate", "to": "getPrivateLat", "label": "true" },
        { "from": "getPrivateLat", "to": "getPrivateLng" },
        { "from": "getPrivateLng", "to": "updatePublicPos" },
        { "from": "iteratePlayers", "to": "end", "label": "done" }
      ]
    }
  ]
}

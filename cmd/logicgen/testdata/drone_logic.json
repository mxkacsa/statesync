{
  "version": "1.0",
  "package": "drone",
  "imports": [],
  "handlers": [
    {
      "name": "OnAddDrone",
      "event": "AddDrone",
      "parameters": [
        {"name": "playerID", "type": "string"},
        {"name": "droneID", "type": "string"}
      ],
      "nodes": [
        {
          "id": "getPlayer",
          "type": "GetPlayer",
          "inputs": {
            "playerID": "param:playerID"
          }
        },
        {
          "id": "getPlayerLat",
          "type": "GetStructField",
          "inputs": {
            "object": "node:getPlayer:player",
            "field": {"constant": "Lat"}
          }
        },
        {
          "id": "getPlayerLng",
          "type": "GetStructField",
          "inputs": {
            "object": "node:getPlayer:player",
            "field": {"constant": "Lng"}
          }
        },
        {
          "id": "createDrone",
          "type": "CreateStruct",
          "inputs": {
            "type": {"constant": "Drone"},
            "fields": {
              "ID": "param:droneID",
              "OwnerID": "param:playerID",
              "Lat": "node:getPlayerLat:value",
              "Lng": "node:getPlayerLng:value",
              "TargetLat": {"constant": 0.0},
              "TargetLng": {"constant": 0.0},
              "HasTarget": {"constant": false},
              "Speed": {"constant": 4.166666666666667}
            }
          }
        },
        {
          "id": "appendDrone",
          "type": "ArrayAppend",
          "inputs": {
            "path": {"constant": "Drones"},
            "item": "node:createDrone:result"
          }
        },
        {
          "id": "emitDroneAdded",
          "type": "EmitToAll",
          "inputs": {
            "eventType": {"constant": "DroneAdded"}
          }
        }
      ],
      "flow": [
        {"from": "start", "to": "getPlayer"},
        {"from": "getPlayer", "to": "getPlayerLat"},
        {"from": "getPlayerLat", "to": "getPlayerLng"},
        {"from": "getPlayerLng", "to": "createDrone"},
        {"from": "createDrone", "to": "appendDrone"},
        {"from": "appendDrone", "to": "emitDroneAdded"},
        {"from": "emitDroneAdded", "to": "end"}
      ]
    },
    {
      "name": "OnSetDroneTarget",
      "event": "SetDroneTarget",
      "parameters": [
        {"name": "droneID", "type": "string"},
        {"name": "targetLat", "type": "float64"},
        {"name": "targetLng", "type": "float64"}
      ],
      "nodes": [
        {
          "id": "updateDrone",
          "type": "UpdateWhere",
          "inputs": {
            "path": {"constant": "Drones"},
            "whereField": {"constant": "ID"},
            "whereOp": {"constant": "=="},
            "whereValue": "param:droneID",
            "updates": {
              "TargetLat": "param:targetLat",
              "TargetLng": "param:targetLng",
              "HasTarget": {"constant": true}
            }
          }
        },
        {
          "id": "emitTargetSet",
          "type": "EmitToAll",
          "inputs": {
            "eventType": {"constant": "DroneTargetSet"}
          }
        }
      ],
      "flow": [
        {"from": "start", "to": "updateDrone"},
        {"from": "updateDrone", "to": "emitTargetSet"},
        {"from": "emitTargetSet", "to": "end"}
      ]
    },
    {
      "name": "OnTick",
      "event": "Tick",
      "parameters": [],
      "nodes": [
        {
          "id": "getTick",
          "type": "GetField",
          "inputs": {
            "path": {"constant": "TickCount"}
          }
        },
        {
          "id": "addTick",
          "type": "Add",
          "inputs": {
            "a": "node:getTick:value",
            "b": {"constant": 1}
          }
        },
        {
          "id": "setTick",
          "type": "SetField",
          "inputs": {
            "path": {"constant": "TickCount"},
            "value": "node:addTick:result"
          }
        },
        {
          "id": "iterateDrones",
          "type": "ForEachWhere",
          "inputs": {
            "array": "state:Drones",
            "field": {"constant": "HasTarget"},
            "op": {"constant": "=="},
            "value": {"constant": true}
          }
        },
        {
          "id": "getDroneLat",
          "type": "GetStructField",
          "inputs": {
            "object": "node:iterateDrones:item",
            "field": {"constant": "Lat"}
          }
        },
        {
          "id": "getDroneLng",
          "type": "GetStructField",
          "inputs": {
            "object": "node:iterateDrones:item",
            "field": {"constant": "Lng"}
          }
        },
        {
          "id": "getTargetLat",
          "type": "GetStructField",
          "inputs": {
            "object": "node:iterateDrones:item",
            "field": {"constant": "TargetLat"}
          }
        },
        {
          "id": "getTargetLng",
          "type": "GetStructField",
          "inputs": {
            "object": "node:iterateDrones:item",
            "field": {"constant": "TargetLng"}
          }
        },
        {
          "id": "calcDistance",
          "type": "GpsDistance",
          "inputs": {
            "lat1": "node:getDroneLat:value",
            "lng1": "node:getDroneLng:value",
            "lat2": "node:getTargetLat:value",
            "lng2": "node:getTargetLng:value"
          }
        },
        {
          "id": "checkNotArrived",
          "type": "Compare",
          "inputs": {
            "left": "node:calcDistance:distance",
            "op": {"constant": ">"},
            "right": {"constant": 1.0}
          }
        },
        {
          "id": "ifNotArrived",
          "type": "If",
          "inputs": {
            "condition": "node:checkNotArrived:result"
          }
        },
        {
          "id": "moveToward",
          "type": "GpsMoveToward",
          "inputs": {
            "fromLat": "node:getDroneLat:value",
            "fromLng": "node:getDroneLng:value",
            "toLat": "node:getTargetLat:value",
            "toLng": "node:getTargetLng:value",
            "distance": {"constant": 12.5}
          }
        },
        {
          "id": "updateDronePos",
          "type": "UpdateStruct",
          "inputs": {
            "object": "node:iterateDrones:item",
            "fields": {
              "Lat": "node:moveToward:newLat",
              "Lng": "node:moveToward:newLng"
            }
          }
        },
        {
          "id": "clearTarget",
          "type": "UpdateStruct",
          "inputs": {
            "object": "node:iterateDrones:item",
            "fields": {
              "HasTarget": {"constant": false}
            }
          }
        },
        {
          "id": "emitDronesMoved",
          "type": "EmitToAll",
          "inputs": {
            "eventType": {"constant": "DronesMoved"}
          }
        }
      ],
      "flow": [
        {"from": "start", "to": "getTick"},
        {"from": "getTick", "to": "addTick"},
        {"from": "addTick", "to": "setTick"},
        {"from": "setTick", "to": "iterateDrones"},
        {"from": "iterateDrones", "to": "getDroneLat", "label": "body"},
        {"from": "getDroneLat", "to": "getDroneLng", "label": "body"},
        {"from": "getDroneLng", "to": "getTargetLat", "label": "body"},
        {"from": "getTargetLat", "to": "getTargetLng", "label": "body"},
        {"from": "getTargetLng", "to": "calcDistance", "label": "body"},
        {"from": "calcDistance", "to": "checkNotArrived", "label": "body"},
        {"from": "checkNotArrived", "to": "ifNotArrived", "label": "body"},
        {"from": "ifNotArrived", "to": "moveToward", "label": "true"},
        {"from": "ifNotArrived", "to": "clearTarget", "label": "false"},
        {"from": "moveToward", "to": "updateDronePos"},
        {"from": "updateDronePos", "to": "end"},
        {"from": "clearTarget", "to": "end"},
        {"from": "iterateDrones", "to": "emitDronesMoved", "label": "done"},
        {"from": "emitDronesMoved", "to": "end"}
      ]
    }
  ]
}
